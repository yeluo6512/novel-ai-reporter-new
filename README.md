# CTO Agents Backend

CTO Agents Backend is a FastAPI-powered service that centralises shared configuration, agent metadata, and health reporting for the cto.new agent platform. It provides a lightweight API surface while managing filesystem state for downstream tooling.

## Architecture

### FastAPI service layout
- `app/main.py` bootstraps the application, configures CORS, and wires lifecycle hooks.
- `app/api/routes` exposes HTTP routes (currently a `/health` probe) using a consistent `ResponseEnvelope` model from `app/models/common.py`.
- `app/core/settings.py` declares strongly typed configuration sourced from environment variables via `pydantic-settings` and ensures required directories exist.
- `app/core/agents.py` manages the cached `agents.md` manifest, creating a default template and metadata on startup.

### Agents manifest & data workflow
- **Manifest defaults** – If `agents.md` is missing, the service writes a starter manifest including stub agent guidance and timestamps. The path is resolved from `APP_CONFIG_DIR` (default `BASE_DIR/config`).
- **Data directories** – `APP_BASE_DIR` anchors where runtime assets live. By default it resolves to `/app` inside a container or the repository root locally. The service guarantees the existence of:
  - `config/` – configuration files such as `agents.md`.
  - `data/` – scratch space for artefacts.
  - `data/projects/` – per-project folders used by downstream agents.
- **Final report handling** – Final reports are expected to live alongside project artefacts (for example `data/projects/<project-id>/final_report.md`). The backend never overwrites these files; editing is left to orchestration tooling or humans so historical context is preserved.

## Environment setup

1. Install **Python 3.12** and ensure `pip` is available.
2. Create and activate a virtual environment:
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   ```
3. Install dependencies (add `[dev]` for local testing utilities):
   ```bash
   pip install -e .
   # or
   pip install -e .[dev]
   ```
4. Copy the sample environment file and adjust values as needed:
   ```bash
   cp .env.sample .env
   ```

### Running the application locally

- Uvicorn (recommended for development):
  ```bash
  uvicorn app.main:app --reload
  ```
- Module entrypoint (mirrors production defaults):
  ```bash
  python -m app
  ```

Visit `http://127.0.0.1:8000/health` to verify the service is running.

### Running tests

Optional development extras install `pytest` and `httpx`:
```bash
pip install -e .[dev]
pytest
```

## Docker Compose usage

A minimal Compose definition can run the backend without managing Python locally:

```yaml
services:
  backend:
    image: python:3.12-slim
    working_dir: /app
    volumes:
      - ./:/app
    command: >-
      sh -c "pip install --no-cache-dir -e . && uvicorn app.main:app --host 0.0.0.0 --port 8000"
    env_file:
      - .env
    ports:
      - "8000:8000"
```

1. Save the snippet above as `compose.yaml` in the repository root (or adapt an existing compose file).
2. Copy `.env.sample` to `.env` and update secrets and paths.
3. Start the stack:
   ```bash
   docker compose up --build
   ```

The mounted volume ensures changes to source files or manifests on your host are instantly reflected inside the container. Persisted data (config and project outputs) will be written under the host directory configured by your `.env` file.

## Configuration reference

`.env.sample` lists all recognised environment variables. Key options include:

| Variable | Description | Default behaviour |
| --- | --- | --- |
| `APP_APP_NAME` / `APP_APP_VERSION` | Optional overrides for metadata shown in responses. | "CTO Agents Backend" / `0.1.0` |
| `APP_ENVIRONMENT` | Environment label surfaced in logs and diagnostics. | `development` |
| `APP_PROVIDER_BASE_URL` | Base URL for upstream provider integrations. | Unset (feature disabled). |
| `APP_PROVIDER_API_KEY` | Credential for provider requests. | Unset. |
| `APP_ALLOWED_ORIGINS` | Comma-separated CORS allow list. Empty means allow all. | `[]` |
| `APP_BASE_DIR` | Root directory for derived paths. | `/app` if writable, otherwise repo root. |
| `APP_CONFIG_DIR` | Override for the configuration directory. | `<APP_BASE_DIR>/config` |
| `APP_DATA_DIR` | Override for general data storage. | `<APP_BASE_DIR>/data` |
| `APP_PROJECTS_SUBDIR` | Name of the projects folder under `data`. | `projects` |
| `APP_AGENTS_MANIFEST_NAME` | Filename of the agents manifest. | `agents.md` |

Any value left unset in `.env` will fall back to these defaults via `pydantic-settings`.

## Workflow guidelines

1. Keep `.env` up to date with relevant API credentials and filesystem paths.
2. Treat `config/agents.md` as source-controlled documentation for available agents; update it manually as capabilities evolve.
3. Use `data/projects/<id>/` to capture artefacts generated by automation. Append to `final_report.md` rather than replacing it to retain auditability.
4. Run `pytest` or invoke endpoint smoke tests before pushing changes to ensure envelope formats remain stable.

The backend deliberately keeps functionality lean so that new routes and storage adapters can be added incrementally while reusing the same configuration surface.
